#!/usr/bin/env python
import sys
sys.path.insert(0, "..")
from Configure import gen_anomaly_dot
import settings
from util import Namespace
import argparse

zeros = lambda s:[[0 for i in xrange(s[1])] for j in xrange(s[0])]
def get_inet_adj_mat(fname):
    """change the topology file with inet format to
    adjacent matrix.
    """
    fid = open(fname, 'r')
    i = -1
    while True:
        i += 1
        line = fid.readline()
        if not line: break
        if i == 0:
            totnode, totlink = [int(s.strip()) for s in line.rsplit()]
            adj_mat = zeros([totnode, totnode])
            continue
        if i <= totnode: # ignore the position information
            continue

        _from, _to, _lineBuffer = [s.strip() for s in line.rsplit()]
        adj_mat[int(_from)][int(_to)] = 1
    fid.close()

    return adj_mat

class ImalseSettings(object):
    """This Experiment Load the network configurations generated by Imalse GUI tool
    and generate the data correspondingly.
    """
    def __init__(self):
        self.parser = argparse.ArgumentParser(description='ImalseSettings')
        self.initparser(self.parser)
        self.args, self.re_args = self.parser.parse_known_args()

    def initparser(self, parser):
        parser.add_argument('--topology_file', default='misc/imalse/topology.inet',
                help='topology file generated by imalse GUI tool')
        parser.add_argument('--net_settings_file', default='misc/imalse/net_settings.py',
                help='net_settings file generated by imalse GUI tool')
        parser.add_argument('--traf_pattern', default='misc/imalse/traffic_pattern.py',
        # parser.add_argument('--traf_pattern', default='settings.py',
                help='files that contains the traffic pattern')
        parser.add_argument('-t', '--simtime', default=5000,
                help='simulatuion time')
        parser.add_argument('--dot_file', default='misc/imalse/conf.dot',
                help='the configured dot file')

    def load_para(self, f_name, encap=Namespace, **kwargs):
        """load parameters. **kwargs** contains some
        additional parameters"""
        s = kwargs
        execfile(f_name, s)
        return s if encap is None else encap(s)
        # return Namespace(s)

    def get_net_desc(self):
        topo = get_inet_adj_mat(settings.ROOT + '/' + self.args.topology_file)
        net_settings = self.load_para(f_name=settings.ROOT + '/' + self.args.net_settings_file, encap=None)
        net_settings['topo'] = topo
        net_settings['node_type'] = 'NNode'
        net_settings['node_para'] = {}
        net_settings['srv_list'] = net_settings['server_id_set']
        # import pdb;pdb.set_trace()
        return net_settings

    def configure(self):
        traf_pattern = self.load_para(
                f_name = settings.ROOT + '/' + self.args.traf_pattern,
                sim_t = self.args.simtime,
                )

                # topo = topo,
                # srv_node_list = net_settings.server_id_set,

        dot_file = settings.ROOT + '/' + self.args.dot_file
        gen_anomaly_dot(
                traf_pattern.ANO_LIST,
                self.get_net_desc(),
                traf_pattern.NORM_DESC,
                dot_file,
                )
        return dot_file

if __name__ == "__main__":
    exper = ImalseSettings()
    exper.configure()
